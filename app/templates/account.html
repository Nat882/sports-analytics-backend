<!-- app/templates/account.html -->
<!DOCTYPE html>
<html>
<head>
  <title>My Account</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  {% include "navbar.html" %}

  <h1 style="text-align: center;">My Favorites</h1>

  <form method="POST" style="text-align: center; margin-bottom: 20px;">
    <label>Select Type:</label>
    <select name="type" onchange="this.form.submit()">
      <option value="player" {% if selected_type == 'player' %}selected{% endif %}>Players</option>
      <option value="team" {% if selected_type == 'team' %}selected{% endif %}>Teams</option>
    </select>
  </form>

  <div style="text-align: center;">
    {% if selected_type == 'player' %}
      <h2>Favorite Players</h2>
      <ul style="list-style: none; text-align: center;">
        {% for p in favorite_players %}
          <li>
            <a href="#" class="favorite-item" data-type="player" data-id="{{ p.player_id }}">
              {{ p.player_name }}
            </a>
          </li>
        {% endfor %}
        {% if not favorite_players %}
          <li>No favorite players yet.</li>
        {% endif %}
      </ul>
    {% else %}
      <h2>Favorite Teams</h2>
      <ul style="list-style: none; text-align: center;">
        {% for t in favorite_teams %}
          <li>
            <a href="#" class="favorite-item" data-type="team" data-id="{{ t.team_id }}">
              {{ t.team_name }}
            </a>
          </li>
        {% endfor %}
        {% if not favorite_teams %}
          <li>No favorite teams yet.</li>
        {% endif %}
      </ul>
    {% endif %}
  </div>

  <div style="max-width: 800px; margin: 0 auto;">
    <h2 id="chart-title" style="text-align: center;"></h2>
    <div style="text-align: center; margin-bottom: 10px;">
      <label for="chartType">Select Graph Type:</label>
      <select id="chartType">
        <option value="bar">Bar Chart</option>
        <option value="line">Line Chart</option>
        <option value="radar">Radar Chart</option>
      </select>
    </div>
    <canvas id="statsChart"></canvas>
  </div>

  <script>
    // Global variables to store currently displayed data and type for dynamic chart switching.
    window.currentChartFavoriteType = null;
    window.currentChartData = null;

    // Utility function to fetch and display stats for the selected favorite
    async function fetchStats(type, id) {
      let apiUrl = '';
      if (type === 'player') {
        apiUrl = `/api/player_stats/${id}`;
      } else if (type === 'team') {
        apiUrl = `/api/team_stats/${id}`;
      }
      try {
        const response = await fetch(apiUrl);
        const data = await response.json();
        if(data.error) {
          alert(data.error);
          return;
        }
        window.currentChartFavoriteType = type;
        window.currentChartData = data;
        displayChart(type, data);
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    // Function to display a chart with Chart.js using the selected graph type
    function displayChart(type, data) {
      document.getElementById('chart-title').innerText =
        type === 'player'
          ? `Stats for ${data.PLAYER_NAME || 'Selected Player'}`
          : `Stats for ${data.TEAM_NAME || 'Selected Team'}`;

      let labels = [], values = [];
      if (type === 'player') {
        labels = ['GP','PTS','REB','AST','STL','BLK','TOV','FG%'];
        values = [
          data.GP||0, data.PTS||0, data.REB||0, data.AST||0,
          data.STL||0, data.BLK||0, data.TOV||0, data.FG_PCT||0
        ];
      } else {
        labels = ['W','L','PTS','REB','AST','TOV','STL','BLK'];
        values = [
          data.W||0, data.L||0, data.PTS||0, data.REB||0,
          data.AST||0, data.TOV||0, data.STL||0, data.BLK||0
        ];
      }

      const selectedChartType = document.getElementById('chartType').value;
      if(window.statsChartInstance) window.statsChartInstance.destroy();

      const ctx = document.getElementById('statsChart').getContext('2d');
      window.statsChartInstance = new Chart(ctx, {
        type: selectedChartType,
        data: {
          labels, datasets:[{
            label:'Per Game Stats', data:values,
            backgroundColor:'rgba(54, 162, 235, 0.5)',
            borderColor:'rgba(54, 162, 235, 1)',
            borderWidth:1,
            fill:selectedChartType==='line'?false:true
          }]
        },
        options:{ scales:{ y:{ beginAtZero:true } } }
      });
    }

    document.querySelectorAll('.favorite-item').forEach(item=>{
      item.addEventListener('click',function(e){
        e.preventDefault();
        fetchStats(this.dataset.type, this.dataset.id);
      });
    });

    document.getElementById('chartType').addEventListener('change',function(){
      if(window.currentChartData && window.currentChartFavoriteType) {
        displayChart(window.currentChartFavoriteType, window.currentChartData);
      }
    });
  </script>
</body>
</html>
